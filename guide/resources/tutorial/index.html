<!DOCTYPE html><html><head><title>Mazurka | Resources - Tutorial</title><meta name=description content="Hypermedia toolkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta property=og:title content="Mazurka | Resources - Tutorial"><meta property=og:site_name content=mazurka.io><meta property=og:url content="https://www.mazurka.io/guide/resources/tutorial/"><meta property=og:description content="Hypermedia toolkit"><meta property=og:type content=article><meta property=og:locale content=en_US><link rel=stylesheet href=/main.min.css><link rel=icon type=image/png href=/favicon.png><body><div class=Toolbar><div class=Toolbar-contents><a href="/" class=Toolbar-logo><div class=Toolbar-logo-image></div><div class=Toolbar-logo-text>Mazurka</div></a><div class=Toolbar-links><a href=/guide/introduction/overview class=Toolbar-link>Guide</a><a href="http://hexdocs.pm/mazurka/" class=Toolbar-link>Documentation</a><a href=https://github.com/mazurka/mazurka class=Toolbar-link>Repository</a><a href=https://github.com/mazurka/mazurka/blob/master/CHANGELOG.md class=Toolbar-link>Changelog</a></div></div></div><div class=Guide><div class=Guide-sidenav><ul class=Guide-sidenav-links><li class=Guide-sidenav-link><div class=Guide-sidenav-link-text><a href="/guide/introduction/overview/" class=Guide-sidenav-link-anchor>Introduction</a></div><ul class=Guide-sidenav-sublinks><li class=Guide-sidenav-sublink><a href="/guide/introduction/overview/" class=Guide-sidenav-sublink-anchor>Overview</a></li><li class=Guide-sidenav-sublink><a href="/guide/introduction/design/" class=Guide-sidenav-sublink-anchor>Design</a></li><li class=Guide-sidenav-sublink><a href="/guide/introduction/installation/" class=Guide-sidenav-sublink-anchor>Installation</a></li><li class=Guide-sidenav-sublink><a href="/guide/introduction/references/" class=Guide-sidenav-sublink-anchor>References</a></li></ul></li><li class=Guide-sidenav-link><div class=Guide-sidenav-link-text><a href="/guide/protocols/overview/" class=Guide-sidenav-link-anchor>Protocols</a></div><ul class=Guide-sidenav-sublinks><li class=Guide-sidenav-sublink><a href="/guide/protocols/overview/" class=Guide-sidenav-sublink-anchor>Overview</a></li><li class=Guide-sidenav-sublink><a href="/guide/protocols/references/" class=Guide-sidenav-sublink-anchor>References</a></li></ul></li><li class=Guide-sidenav-link><div class=Guide-sidenav-link-text><a href="/guide/resources/overview/" class="Guide-sidenav-link-anchor is-active">Resources</a></div><ul class=Guide-sidenav-sublinks><li class=Guide-sidenav-sublink><a href="/guide/resources/overview/" class=Guide-sidenav-sublink-anchor>Overview</a></li><li class=Guide-sidenav-sublink><a href="/guide/resources/design/" class=Guide-sidenav-sublink-anchor>Design</a></li><li class=Guide-sidenav-sublink><a href="/guide/resources/tutorial/" class="Guide-sidenav-sublink-anchor is-active">Tutorial</a></li><li class=Guide-sidenav-sublink><a href="/guide/resources/mediatypes/" class=Guide-sidenav-sublink-anchor>Mediatypes</a></li><li class=Guide-sidenav-sublink><a href="/guide/resources/testing/" class=Guide-sidenav-sublink-anchor>Testing</a></li><li class=Guide-sidenav-sublink><a href="/guide/resources/references/" class=Guide-sidenav-sublink-anchor>References</a></li></ul></li><li class=Guide-sidenav-link><div class=Guide-sidenav-link-text><a href="/guide/dispatch/overview/" class=Guide-sidenav-link-anchor>Dispatch</a></div><ul class=Guide-sidenav-sublinks><li class=Guide-sidenav-sublink><a href="/guide/dispatch/overview/" class=Guide-sidenav-sublink-anchor>Overview</a></li><li class=Guide-sidenav-sublink><a href="/guide/dispatch/references/" class=Guide-sidenav-sublink-anchor>References</a></li></ul></li><li class=Guide-sidenav-link><div class=Guide-sidenav-link-text><a href="/guide/services/overview/" class=Guide-sidenav-link-anchor>Services</a></div><ul class=Guide-sidenav-sublinks><li class=Guide-sidenav-sublink><a href="/guide/services/overview/" class=Guide-sidenav-sublink-anchor>Overview</a></li><li class=Guide-sidenav-sublink><a href="/guide/services/references/" class=Guide-sidenav-sublink-anchor>References</a></li></ul></li></ul></div><div class=Guide-content><a target=__blank href=https://github.com/mazurka/mazurka.github.io/edit/source/src/modules/pages/guide/resources/tutorial.md class=Guide-content-edit>Edit this page</a><h1>Tutorial<a id=tutorial class=Header-anchor href=#tutorial aria-hidden=true><span class=Header-anchor-icon></span></a></h1><p>When declaring a Mazurka resource several macros are imported for resource construction and definition. We&#39;ll walk through examples of each one as we build a few resources dealing with users. Let&#39;s start be creating a <code>MyAPI.Resource.Users.Read</code> resource.</p><pre><code class="hljs elixir[initial]"><span id=code-initial-1><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span></span>
<span id=code-initial-2>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span></span>
<span id=code-initial-3><span class=hljs-keyword>end</span></span>
</code></pre><h2>param<a id=param class=Header-anchor href=#param aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>The <code>param</code> macro declares what parameters should be passed into the resource. This information can be used to generate documentation and verify that protocols or other resources are passing the correct information.</p><p>In our example resource we&#39;re declaring that <code>user</code> is required to respond to a request.</p><pre><code class="hljs elixir[param_no_validate&lt;-initial]"><span id=code-param_no_validate-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-param_no_validate-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-param_no_validate-2 class=hljs-diff-line-added>  param user
</span><span id=code-param_no_validate-3 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>If we want to validate or transform the param we can pass a <code>do</code> block. The value of the parameter will be available as the variable <code>value</code>. This makes it easy to check the value against a <a href=/guide/services/overview>service</a>.</p><p>In this example we&#39;ll call the <code>Users.read/1</code> service and get a <code>User</code> struct back.</p><pre><code class="hljs elixir[param&lt;-param_no_validate]"><span id=code-param-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-param-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-param-2 class=hljs-diff-line-removed>  param user
</span><span id=code-param-3 class=hljs-diff-line-added>  param user <span class=hljs-keyword>do</span>
</span><span id=code-param-4 class=hljs-diff-line-added>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-param-5 class=hljs-diff-line-added>  <span class=hljs-keyword>end</span>
</span><span id=code-param-6 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>We can add as many of the <code>param</code> delcarations as we would like, however in this example, we&#39;ll just stick to one.</p><h2>mediatype<a id=mediatype class=Header-anchor href=#mediatype aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>Now we&#39;ll add a <code>mediatype</code> block. This is where we declare the available mediatypes for this resource. In this example we&#39;ll use the <code>hyper+json</code> mediatype. Each individual mediatype can import its own set of macros in this block. Check out the <a href=/guide/resources/mediatypes>mediatypes section</a> for more information on the types available.</p><pre><code class="hljs elixir[mediatype&lt;-param]"><span id=code-mediatype-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-mediatype-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-mediatype-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-mediatype-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-mediatype-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-mediatype-5 class=hljs-diff-line-added>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span>
<span id=code-mediatype-6 class=hljs-diff-line-added>  <span class=hljs-keyword>end</span>
</span><span id=code-mediatype-7 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><h2>action<a id=action class=Header-anchor href=#action aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>Every <a href=#mediatype>mediatype</a> block needs an action handler. This is called after all of the conditions are met. Inside, we define what happens when this resource is requested by a client. All side-effects should be contained in this block. The response from the action will be serialized and sent to the client.</p><p>Here we&#39;re just going to send a read-only response to the client. This will include the user&#39;s <code>name</code> and <code>avatar</code>.</p><pre><code class="hljs elixir[action&lt;-mediatype]"><span id=code-action-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-action-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-action-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-action-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-action-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-action-5 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span>
<span id=code-action-6 class=hljs-diff-line-added>    action <span class=hljs-keyword>do</span>
</span><span id=code-action-7 class=hljs-diff-line-added>      %{
</span><span id=code-action-8 class=hljs-diff-line-added>        <span class=hljs-string>"name"</span> =&gt; user.name,
</span><span id=code-action-9 class=hljs-diff-line-added>        <span class=hljs-string>"avatar"</span> =&gt; %{
</span><span id=code-action-10 class=hljs-diff-line-added>          <span class=hljs-string>"src"</span> =&gt; user.image
</span><span id=code-action-11 class=hljs-diff-line-added>        },
</span><span id=code-action-12 class=hljs-diff-line-added>      }
</span><span id=code-action-13 class=hljs-diff-line-added>    <span class=hljs-keyword>end</span>
</span><span id=code-action-14 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-action-15 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>Now we can finally make a request to this resource! Let&#39;s say we&#39;ve mounted it at <code>/users/:user</code> through the HTTP protocol.</p><pre><code class="hljs sh[req_action]"><span id=code-req_action-1>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1</span>
<span id=code-req_action-2></span>
<span id=code-req_action-3>{</span>
<span id=code-req_action-4>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,</span>
<span id=code-req_action-5>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,</span>
<span id=code-req_action-6>  <span class=hljs-string>"avatar"</span>: {</span>
<span id=code-req_action-7>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span></span>
<span id=code-req_action-8>  }</span>
<span id=code-req_action-9>}</span>
</code></pre><h2>let<a id=let class=Header-anchor href=#let aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>What if we want to get a list of a user&#39;s friends? We have the <code>let</code> macro to assign request wide variables that we can go on to use in the resource.</p><p>Here, we&#39;ll call the <code>Users.find_friends/1</code> service which will return a list of <code>User</code> ids. We&#39;ll perform a comprehension over this list and return the id.</p><pre><code class="hljs elixir[init_let&lt;-action]"><span id=code-init_let-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-init_let-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-init_let-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-init_let-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-init_let-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-init_let-5 class=hljs-diff-line-added>  let friends = <span class=hljs-constant>Users.</span>find_friends(user.id)
</span>
<span id=code-init_let-6 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-init_let-7 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-init_let-8 class=hljs-diff-line-unchanged>      %{
</span><span id=code-init_let-9 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; user.name,
</span><span id=code-init_let-10 class=hljs-diff-line-unchanged>        <span class=hljs-string>"avatar"</span> =&gt; %{
</span><span id=code-init_let-11 class=hljs-diff-line-unchanged>          <span class=hljs-string>"src"</span> =&gt; user.image
</span><span id=code-init_let-12 class=hljs-diff-line-unchanged>        },
</span><span id=code-init_let-13 class=hljs-diff-line-added>        <span class=hljs-string>"friends"</span> =&gt; <span class=hljs-keyword>for</span> friend &lt;- friends <span class=hljs-keyword>do</span>
</span><span id=code-init_let-14 class=hljs-diff-line-added>          friend
</span><span id=code-init_let-15 class=hljs-diff-line-added>        <span class=hljs-keyword>end</span>,
</span><span id=code-init_let-16 class=hljs-diff-line-unchanged>      }
</span><span id=code-init_let-17 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span><span id=code-init_let-18 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-init_let-19 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>If we make a request to this resource now we&#39;ll see something like this:</p><pre><code class="hljs sh[req_let_w_friends&lt;-req_action]"><span id=code-req_let_w_friends-0 class=hljs-diff-line-unchanged>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1
</span>
<span id=code-req_let_w_friends-1 class=hljs-diff-line-unchanged>{
</span><span id=code-req_let_w_friends-2 class=hljs-diff-line-unchanged>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_let_w_friends-3 class=hljs-diff-line-unchanged>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_let_w_friends-4 class=hljs-diff-line-unchanged>  <span class=hljs-string>"avatar"</span>: {
</span><span id=code-req_let_w_friends-5 class=hljs-diff-line-unchanged>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span>
</span><span id=code-req_let_w_friends-6 class=hljs-diff-line-removed>  }
</span><span id=code-req_let_w_friends-7 class=hljs-diff-line-added>  },
</span><span id=code-req_let_w_friends-8 class=hljs-diff-line-added>  <span class=hljs-string>"friends"</span>: [
</span><span id=code-req_let_w_friends-9 class=hljs-diff-line-added>    <span class=hljs-string>"u2"</span>,
</span><span id=code-req_let_w_friends-10 class=hljs-diff-line-added>    <span class=hljs-string>"u3"</span>
</span><span id=code-req_let_w_friends-11 class=hljs-diff-line-added>  ]
</span><span id=code-req_let_w_friends-12 class=hljs-diff-line-unchanged>}</span>
</code></pre><p><code>let</code> also accepts a <code>do</code> block for more complex computations.</p><p>Here we&#39;ll get a list of user interests by joining the movies and books they&#39;ve liked and returning it to the client.</p><pre><code class="hljs elixir[let&lt;-init_let]"><span id=code-let-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-let-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-let-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-let-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-let-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-let-5 class=hljs-diff-line-unchanged>  let friends = <span class=hljs-constant>Users.</span>find_friends(user.id)
</span><span id=code-let-6 class=hljs-diff-line-added>  let interests <span class=hljs-keyword>do</span>
</span><span id=code-let-7 class=hljs-diff-line-added>    movies = <span class=hljs-constant>Movies.</span>find_liked_by_user(user.id)
</span><span id=code-let-8 class=hljs-diff-line-added>    books = <span class=hljs-constant>Books.</span>find_linked_by_user(user.id)
</span><span id=code-let-9 class=hljs-diff-line-added>    movies ++ books
</span><span id=code-let-10 class=hljs-diff-line-added>  <span class=hljs-keyword>end</span>
</span>
<span id=code-let-11 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-let-12 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-let-13 class=hljs-diff-line-unchanged>      %{
</span><span id=code-let-14 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; user.name,
</span><span id=code-let-15 class=hljs-diff-line-unchanged>        <span class=hljs-string>"avatar"</span> =&gt; %{
</span><span id=code-let-16 class=hljs-diff-line-unchanged>          <span class=hljs-string>"src"</span> =&gt; user.image
</span><span id=code-let-17 class=hljs-diff-line-unchanged>        },
</span><span id=code-let-18 class=hljs-diff-line-unchanged>        <span class=hljs-string>"friends"</span> =&gt; <span class=hljs-keyword>for</span> friend &lt;- friends <span class=hljs-keyword>do</span>
</span><span id=code-let-19 class=hljs-diff-line-unchanged>          friend
</span><span id=code-let-20 class=hljs-diff-line-unchanged>        <span class=hljs-keyword>end</span>,
</span><span id=code-let-21 class=hljs-diff-line-added>        <span class=hljs-string>"interests"</span> =&gt; <span class=hljs-keyword>for</span> interest &lt;- interests <span class=hljs-keyword>do</span>
</span><span id=code-let-22 class=hljs-diff-line-added>          interest
</span><span id=code-let-23 class=hljs-diff-line-added>        <span class=hljs-keyword>end</span>,
</span><span id=code-let-24 class=hljs-diff-line-unchanged>      }
</span><span id=code-let-25 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span><span id=code-let-26 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-let-27 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>Let&#39;s make another request and see how it&#39;s changed.</p><pre><code class="hljs sh[req_let&lt;-req_let_w_friends]"><span id=code-req_let-0 class=hljs-diff-line-unchanged>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1
</span>
<span id=code-req_let-1 class=hljs-diff-line-unchanged>{
</span><span id=code-req_let-2 class=hljs-diff-line-unchanged>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_let-3 class=hljs-diff-line-unchanged>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_let-4 class=hljs-diff-line-unchanged>  <span class=hljs-string>"avatar"</span>: {
</span><span id=code-req_let-5 class=hljs-diff-line-unchanged>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span>
</span><span id=code-req_let-6 class=hljs-diff-line-unchanged>  },
</span><span id=code-req_let-7 class=hljs-diff-line-unchanged>  <span class=hljs-string>"friends"</span>: [
</span><span id=code-req_let-8 class=hljs-diff-line-unchanged>    <span class=hljs-string>"u2"</span>,
</span><span id=code-req_let-9 class=hljs-diff-line-unchanged>    <span class=hljs-string>"u3"</span>
</span><span id=code-req_let-10 class=hljs-diff-line-added>  ],
</span><span id=code-req_let-11 class=hljs-diff-line-added>  <span class=hljs-string>"interests"</span>: [
</span><span id=code-req_let-12 class=hljs-diff-line-added>    <span class=hljs-string>"m1"</span>,
</span><span id=code-req_let-13 class=hljs-diff-line-added>    <span class=hljs-string>"m2"</span>,
</span><span id=code-req_let-14 class=hljs-diff-line-added>    <span class=hljs-string>"b1"</span>,
</span><span id=code-req_let-15 class=hljs-diff-line-added>    <span class=hljs-string>"b2"</span>
</span><span id=code-req_let-16 class=hljs-diff-line-unchanged>  ]
</span><span id=code-req_let-17 class=hljs-diff-line-unchanged>}</span>
</code></pre><p>Keep in mind that the expressions in <code>let</code> are lazy, meaning they will only be computed if the variable name is actually used. This can be a little different than what most programmers are used to. The benefit is we&#39;re never requesting data we don&#39;t need. Check out the <a href=/guide/resources/design>resources design</a> page for more information regarding laziness.</p><h2>link_to<a id=link_to class=Header-anchor href=#link_to aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>You&#39;ll notice in the <a href=#let>let</a> section we iterated over the list of friends and interests and returned their ids. This would be normal for traditional APIs. However, in hypermedia APIs we want to return a link to the resource so the client can easily resolve it. We can accomplish this with the <code>link_to</code> function.</p><pre><code class="hljs elixir[link_to&lt;-let]"><span id=code-link_to-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-link_to-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-link_to-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-link_to-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-link_to-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-link_to-5 class=hljs-diff-line-unchanged>  let friends = <span class=hljs-constant>Users.</span>find_friends(user.id)
</span><span id=code-link_to-6 class=hljs-diff-line-unchanged>  let interests <span class=hljs-keyword>do</span>
</span><span id=code-link_to-7 class=hljs-diff-line-unchanged>    movies = <span class=hljs-constant>Movies.</span>find_liked_by_user(user.id)
</span><span id=code-link_to-8 class=hljs-diff-line-unchanged>    books = <span class=hljs-constant>Books.</span>find_linked_by_user(user.id)
</span><span id=code-link_to-9 class=hljs-diff-line-unchanged>    movies ++ books
</span><span id=code-link_to-10 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-link_to-11 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-link_to-12 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-link_to-13 class=hljs-diff-line-unchanged>      %{
</span><span id=code-link_to-14 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; user.name,
</span><span id=code-link_to-15 class=hljs-diff-line-unchanged>        <span class=hljs-string>"avatar"</span> =&gt; %{
</span><span id=code-link_to-16 class=hljs-diff-line-unchanged>          <span class=hljs-string>"src"</span> =&gt; user.image
</span><span id=code-link_to-17 class=hljs-diff-line-unchanged>        },
</span><span id=code-link_to-18 class=hljs-diff-line-unchanged>        <span class=hljs-string>"friends"</span> =&gt; <span class=hljs-keyword>for</span> friend &lt;- friends <span class=hljs-keyword>do</span>
</span><span id=code-link_to-19 class=hljs-diff-line-removed>          friend
</span><span id=code-link_to-20 class=hljs-diff-line-added>          link_to(<span class=hljs-constant>MyAPI.Resource.Users.Read,</span> <span class=hljs-symbol>user:</span> friend)
</span><span id=code-link_to-21 class=hljs-diff-line-unchanged>        <span class=hljs-keyword>end</span>,
</span><span id=code-link_to-22 class=hljs-diff-line-unchanged>        <span class=hljs-string>"interests"</span> =&gt; <span class=hljs-keyword>for</span> interest &lt;- interests <span class=hljs-keyword>do</span>
</span><span id=code-link_to-23 class=hljs-diff-line-removed>          interest
</span><span id=code-link_to-24 class=hljs-diff-line-added>          link_to(<span class=hljs-constant>MyAPI.Resource.Like.Interest.Read,</span> <span class=hljs-symbol>interest:</span> interest)
</span><span id=code-link_to-25 class=hljs-diff-line-unchanged>        <span class=hljs-keyword>end</span>,
</span><span id=code-link_to-26 class=hljs-diff-line-unchanged>      }
</span><span id=code-link_to-27 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span><span id=code-link_to-28 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-link_to-29 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>Now if we request the resource we get something like this:</p><pre><code class="hljs sh[req_link_to&lt;-req_let]"><span id=code-req_link_to-0 class=hljs-diff-line-unchanged>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1
</span>
<span id=code-req_link_to-1 class=hljs-diff-line-unchanged>{
</span><span id=code-req_link_to-2 class=hljs-diff-line-unchanged>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_link_to-3 class=hljs-diff-line-unchanged>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_link_to-4 class=hljs-diff-line-unchanged>  <span class=hljs-string>"avatar"</span>: {
</span><span id=code-req_link_to-5 class=hljs-diff-line-unchanged>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span>
</span><span id=code-req_link_to-6 class=hljs-diff-line-unchanged>  },
</span><span id=code-req_link_to-7 class=hljs-diff-line-unchanged>  <span class=hljs-string>"friends"</span>: [
</span><span id=code-req_link_to-8 class=hljs-diff-line-removed>    <span class=hljs-string>"u2"</span>,
</span><span id=code-req_link_to-9 class=hljs-diff-line-removed>    <span class=hljs-string>"u3"</span>
</span><span id=code-req_link_to-10 class=hljs-diff-line-added>    {
</span><span id=code-req_link_to-11 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u2"</span>
</span><span id=code-req_link_to-12 class=hljs-diff-line-added>    },
</span><span id=code-req_link_to-13 class=hljs-diff-line-added>    {
</span><span id=code-req_link_to-14 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u3"</span>
</span><span id=code-req_link_to-15 class=hljs-diff-line-added>    }
</span><span id=code-req_link_to-16 class=hljs-diff-line-unchanged>  ],
</span><span id=code-req_link_to-17 class=hljs-diff-line-unchanged>  <span class=hljs-string>"interests"</span>: [
</span><span id=code-req_link_to-18 class=hljs-diff-line-removed>    <span class=hljs-string>"m1"</span>,
</span><span id=code-req_link_to-19 class=hljs-diff-line-removed>    <span class=hljs-string>"m2"</span>,
</span><span id=code-req_link_to-20 class=hljs-diff-line-removed>    <span class=hljs-string>"b1"</span>,
</span><span id=code-req_link_to-21 class=hljs-diff-line-removed>    <span class=hljs-string>"b2"</span>
</span><span id=code-req_link_to-22 class=hljs-diff-line-added>    {
</span><span id=code-req_link_to-23 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m1"</span>
</span><span id=code-req_link_to-24 class=hljs-diff-line-added>    },
</span><span id=code-req_link_to-25 class=hljs-diff-line-added>    {
</span><span id=code-req_link_to-26 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m2"</span>
</span><span id=code-req_link_to-27 class=hljs-diff-line-added>    },
</span><span id=code-req_link_to-28 class=hljs-diff-line-added>    {
</span><span id=code-req_link_to-29 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b1"</span>
</span><span id=code-req_link_to-30 class=hljs-diff-line-added>    },
</span><span id=code-req_link_to-31 class=hljs-diff-line-added>    {
</span><span id=code-req_link_to-32 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b2"</span>
</span><span id=code-req_link_to-33 class=hljs-diff-line-added>    }
</span><span id=code-req_link_to-34 class=hljs-diff-line-unchanged>  ]
</span><span id=code-req_link_to-35 class=hljs-diff-line-unchanged>}</span>
</code></pre><h2>affordance<a id=affordance class=Header-anchor href=#affordance aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>In the previous section we saw that <code>link_to</code> returned a hyperlink to the resource. What if we wanted to change what the link looks like? Glad you asked. That&#39;s what the <code>affordance</code> section is for.</p><p>In this example we&#39;ll add the <code>name</code> property to the link itself so clients won&#39;t have to request all of the friend resources just for the name.</p><pre><code class="hljs elixir[affordance_w_name&lt;-link_to]"><span id=code-affordance_w_name-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-affordance_w_name-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-affordance_w_name-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-affordance_w_name-5 class=hljs-diff-line-unchanged>  let friends = <span class=hljs-constant>Users.</span>find_friends(user.id)
</span><span id=code-affordance_w_name-6 class=hljs-diff-line-unchanged>  let interests <span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-7 class=hljs-diff-line-unchanged>    movies = <span class=hljs-constant>Movies.</span>find_liked_by_user(user.id)
</span><span id=code-affordance_w_name-8 class=hljs-diff-line-unchanged>    books = <span class=hljs-constant>Books.</span>find_linked_by_user(user.id)
</span><span id=code-affordance_w_name-9 class=hljs-diff-line-unchanged>    movies ++ books
</span><span id=code-affordance_w_name-10 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-affordance_w_name-11 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-12 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-13 class=hljs-diff-line-unchanged>      %{
</span><span id=code-affordance_w_name-14 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; user.name,
</span><span id=code-affordance_w_name-15 class=hljs-diff-line-unchanged>        <span class=hljs-string>"avatar"</span> =&gt; %{
</span><span id=code-affordance_w_name-16 class=hljs-diff-line-unchanged>          <span class=hljs-string>"src"</span> =&gt; user.image
</span><span id=code-affordance_w_name-17 class=hljs-diff-line-unchanged>        },
</span><span id=code-affordance_w_name-18 class=hljs-diff-line-unchanged>        <span class=hljs-string>"friends"</span> =&gt; <span class=hljs-keyword>for</span> friend &lt;- friends <span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-19 class=hljs-diff-line-unchanged>          link_to(<span class=hljs-constant>MyAPI.Resource.Users.Read,</span> <span class=hljs-symbol>user:</span> friend)
</span><span id=code-affordance_w_name-20 class=hljs-diff-line-unchanged>        <span class=hljs-keyword>end</span>,
</span><span id=code-affordance_w_name-21 class=hljs-diff-line-unchanged>        <span class=hljs-string>"interests"</span> =&gt; <span class=hljs-keyword>for</span> interest &lt;- interests <span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-22 class=hljs-diff-line-unchanged>          link_to(<span class=hljs-constant>MyAPI.Resource.Like.Interest.Read,</span> <span class=hljs-symbol>interest:</span> interest)
</span><span id=code-affordance_w_name-23 class=hljs-diff-line-unchanged>        <span class=hljs-keyword>end</span>,
</span><span id=code-affordance_w_name-24 class=hljs-diff-line-unchanged>      }
</span><span id=code-affordance_w_name-25 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-affordance_w_name-26 class=hljs-diff-line-added>    affordance <span class=hljs-keyword>do</span>
</span><span id=code-affordance_w_name-27 class=hljs-diff-line-added>      %{
</span><span id=code-affordance_w_name-28 class=hljs-diff-line-added>        <span class=hljs-string>"name"</span> =&gt; user.name
</span><span id=code-affordance_w_name-29 class=hljs-diff-line-added>      }
</span><span id=code-affordance_w_name-30 class=hljs-diff-line-added>    <span class=hljs-keyword>end</span>
</span><span id=code-affordance_w_name-31 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-affordance_w_name-32 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>What does that response look like? You guessed it.</p><pre><code class="hljs sh[req_affordance_w_name&lt;-req_link_to]"><span id=code-req_affordance_w_name-0 class=hljs-diff-line-unchanged>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1
</span>
<span id=code-req_affordance_w_name-1 class=hljs-diff-line-unchanged>{
</span><span id=code-req_affordance_w_name-2 class=hljs-diff-line-unchanged>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_affordance_w_name-3 class=hljs-diff-line-unchanged>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_affordance_w_name-4 class=hljs-diff-line-unchanged>  <span class=hljs-string>"avatar"</span>: {
</span><span id=code-req_affordance_w_name-5 class=hljs-diff-line-unchanged>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span>
</span><span id=code-req_affordance_w_name-6 class=hljs-diff-line-unchanged>  },
</span><span id=code-req_affordance_w_name-7 class=hljs-diff-line-unchanged>  <span class=hljs-string>"friends"</span>: [
</span><span id=code-req_affordance_w_name-8 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance_w_name-9 class=hljs-diff-line-removed>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u2"</span>
</span><span id=code-req_affordance_w_name-10 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u2"</span>,
</span><span id=code-req_affordance_w_name-11 class=hljs-diff-line-added>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Robert"</span>
</span><span id=code-req_affordance_w_name-12 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance_w_name-13 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance_w_name-14 class=hljs-diff-line-removed>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u3"</span>
</span><span id=code-req_affordance_w_name-15 class=hljs-diff-line-added>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u3"</span>,
</span><span id=code-req_affordance_w_name-16 class=hljs-diff-line-added>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Mike"</span>
</span><span id=code-req_affordance_w_name-17 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_affordance_w_name-18 class=hljs-diff-line-unchanged>  ],
</span><span id=code-req_affordance_w_name-19 class=hljs-diff-line-unchanged>  <span class=hljs-string>"interests"</span>: [
</span><span id=code-req_affordance_w_name-20 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance_w_name-21 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m1"</span>
</span><span id=code-req_affordance_w_name-22 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance_w_name-23 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance_w_name-24 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m2"</span>
</span><span id=code-req_affordance_w_name-25 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance_w_name-26 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance_w_name-27 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b1"</span>
</span><span id=code-req_affordance_w_name-28 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance_w_name-29 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance_w_name-30 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b2"</span>
</span><span id=code-req_affordance_w_name-31 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_affordance_w_name-32 class=hljs-diff-line-unchanged>  ]
</span><span id=code-req_affordance_w_name-33 class=hljs-diff-line-unchanged>}</span>
</code></pre><p>Affordances can also be used to build forms. Let&#39;s say there was a another resource called <code>MyAPI.Resource.Users.Update</code>. This resource is in charge of accepting a name for a user and persisting it through the <code>Users</code> service.</p><pre><code class="hljs elixir[user_update]"><span id=code-user_update-1><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Update </span><span class=hljs-keyword>do</span></span>
<span id=code-user_update-2>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span></span>
<span id=code-user_update-3></span>
<span id=code-user_update-4>  param user <span class=hljs-keyword>do</span></span>
<span id=code-user_update-5>    <span class=hljs-constant>Users.</span>read(value)</span>
<span id=code-user_update-6>  <span class=hljs-keyword>end</span></span>
<span id=code-user_update-7></span>
<span id=code-user_update-8>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span></span>
<span id=code-user_update-9>    action <span class=hljs-keyword>do</span></span>
<span id=code-user_update-10>      <span class=hljs-constant>Users.</span>update(user, %{</span>
<span id=code-user_update-11>        <span class=hljs-string>"name"</span> =&gt; <span class=hljs-constant>Input.</span>get(<span class=hljs-string>"name"</span>)</span>
<span id=code-user_update-12>      })</span>
<span id=code-user_update-13>      <span class=hljs-keyword>true</span></span>
<span id=code-user_update-14>    <span class=hljs-keyword>end</span></span>
<span id=code-user_update-15></span>
<span id=code-user_update-16>    affordance <span class=hljs-keyword>do</span></span>
<span id=code-user_update-17>      %{</span>
<span id=code-user_update-18>        <span class=hljs-string>"input"</span> =&gt; %{</span>
<span id=code-user_update-19>          <span class=hljs-string>"name"</span> =&gt; %{</span>
<span id=code-user_update-20>            <span class=hljs-string>"type"</span> =&gt; <span class=hljs-string>"text"</span>,</span>
<span id=code-user_update-21>            <span class=hljs-string>"value"</span> =&gt; user.name,</span>
<span id=code-user_update-22>            <span class=hljs-string>"required"</span> =&gt; <span class=hljs-keyword>true</span></span>
<span id=code-user_update-23>          }</span>
<span id=code-user_update-24>        }</span>
<span id=code-user_update-25>      }</span>
<span id=code-user_update-26>    <span class=hljs-keyword>end</span></span>
<span id=code-user_update-27>  <span class=hljs-keyword>end</span></span>
<span id=code-user_update-28><span class=hljs-keyword>end</span></span>
</code></pre><p>Now let&#39;s link to the update resource from our read.</p><pre><code class="hljs elixir[affordance&lt;-affordance_w_name]"><span id=code-affordance-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Read </span><span class=hljs-keyword>do</span>
</span><span id=code-affordance-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-affordance-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-affordance-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-affordance-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-affordance-5 class=hljs-diff-line-unchanged>  let friends = <span class=hljs-constant>Users.</span>find_friends(user.id)
</span><span id=code-affordance-6 class=hljs-diff-line-unchanged>  let interests <span class=hljs-keyword>do</span>
</span><span id=code-affordance-7 class=hljs-diff-line-unchanged>    movies = <span class=hljs-constant>Movies.</span>find_liked_by_user(user.id)
</span><span id=code-affordance-8 class=hljs-diff-line-unchanged>    books = <span class=hljs-constant>Books.</span>find_linked_by_user(user.id)
</span><span id=code-affordance-9 class=hljs-diff-line-unchanged>    movies ++ books
</span><span id=code-affordance-10 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-affordance-11 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-affordance-12 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-affordance-13 class=hljs-diff-line-unchanged>      %{
</span><span id=code-affordance-14 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; user.name,
</span><span id=code-affordance-15 class=hljs-diff-line-unchanged>        <span class=hljs-string>"avatar"</span> =&gt; %{
</span><span id=code-affordance-16 class=hljs-diff-line-unchanged>          <span class=hljs-string>"src"</span> =&gt; user.image
</span><span id=code-affordance-17 class=hljs-diff-line-unchanged>        },
</span><span id=code-affordance-18 class=hljs-diff-line-unchanged>        <span class=hljs-string>"friends"</span> =&gt; <span class=hljs-keyword>for</span> friend &lt;- friends <span class=hljs-keyword>do</span>
</span><span id=code-affordance-19 class=hljs-diff-line-unchanged>          link_to(<span class=hljs-constant>MyAPI.Resource.Users.Read,</span> <span class=hljs-symbol>user:</span> friend)
</span><span id=code-affordance-20 class=hljs-diff-line-unchanged>        <span class=hljs-keyword>end</span>,
</span><span id=code-affordance-21 class=hljs-diff-line-unchanged>        <span class=hljs-string>"interests"</span> =&gt; <span class=hljs-keyword>for</span> interest &lt;- interests <span class=hljs-keyword>do</span>
</span><span id=code-affordance-22 class=hljs-diff-line-unchanged>          link_to(<span class=hljs-constant>MyAPI.Resource.Like.Interest.Read,</span> <span class=hljs-symbol>interest:</span> interest)
</span><span id=code-affordance-23 class=hljs-diff-line-unchanged>        <span class=hljs-keyword>end</span>,
</span><span id=code-affordance-24 class=hljs-diff-line-added>        <span class=hljs-string>"update"</span> =&gt; link_to(<span class=hljs-constant>MyAPI.Resource.Users.Update,</span> <span class=hljs-symbol>user:</span> user.id),
</span><span id=code-affordance-25 class=hljs-diff-line-unchanged>      }
</span><span id=code-affordance-26 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-affordance-27 class=hljs-diff-line-unchanged>    affordance <span class=hljs-keyword>do</span>
</span><span id=code-affordance-28 class=hljs-diff-line-unchanged>      %{
</span><span id=code-affordance-29 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; user.name
</span><span id=code-affordance-30 class=hljs-diff-line-unchanged>      }
</span><span id=code-affordance-31 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span><span id=code-affordance-32 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-affordance-33 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>Let&#39;s try making a request:</p><pre><code class="hljs sh[req_affordance&lt;-req_affordance_w_name]"><span id=code-req_affordance-0 class=hljs-diff-line-unchanged>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1
</span>
<span id=code-req_affordance-1 class=hljs-diff-line-unchanged>{
</span><span id=code-req_affordance-2 class=hljs-diff-line-unchanged>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_affordance-3 class=hljs-diff-line-unchanged>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_affordance-4 class=hljs-diff-line-unchanged>  <span class=hljs-string>"avatar"</span>: {
</span><span id=code-req_affordance-5 class=hljs-diff-line-unchanged>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span>
</span><span id=code-req_affordance-6 class=hljs-diff-line-unchanged>  },
</span><span id=code-req_affordance-7 class=hljs-diff-line-unchanged>  <span class=hljs-string>"friends"</span>: [
</span><span id=code-req_affordance-8 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance-9 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u2"</span>,
</span><span id=code-req_affordance-10 class=hljs-diff-line-unchanged>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Robert"</span>
</span><span id=code-req_affordance-11 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance-12 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance-13 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u3"</span>,
</span><span id=code-req_affordance-14 class=hljs-diff-line-unchanged>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Mike"</span>
</span><span id=code-req_affordance-15 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_affordance-16 class=hljs-diff-line-unchanged>  ],
</span><span id=code-req_affordance-17 class=hljs-diff-line-unchanged>  <span class=hljs-string>"interests"</span>: [
</span><span id=code-req_affordance-18 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance-19 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m1"</span>
</span><span id=code-req_affordance-20 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance-21 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance-22 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m2"</span>
</span><span id=code-req_affordance-23 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance-24 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance-25 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b1"</span>
</span><span id=code-req_affordance-26 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_affordance-27 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_affordance-28 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b2"</span>
</span><span id=code-req_affordance-29 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_affordance-30 class=hljs-diff-line-removed>  ]
</span><span id=code-req_affordance-31 class=hljs-diff-line-added>  ],
</span><span id=code-req_affordance-32 class=hljs-diff-line-added>  <span class=hljs-string>"update"</span>: {
</span><span id=code-req_affordance-33 class=hljs-diff-line-added>    <span class=hljs-string>"method"</span>: <span class=hljs-string>"POST"</span>,
</span><span id=code-req_affordance-34 class=hljs-diff-line-added>    <span class=hljs-string>"action"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_affordance-35 class=hljs-diff-line-added>    <span class=hljs-string>"input"</span>: {
</span><span id=code-req_affordance-36 class=hljs-diff-line-added>      <span class=hljs-string>"name"</span>: {
</span><span id=code-req_affordance-37 class=hljs-diff-line-added>        <span class=hljs-string>"type"</span>: <span class=hljs-string>"text"</span>,
</span><span id=code-req_affordance-38 class=hljs-diff-line-added>        <span class=hljs-string>"value"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_affordance-39 class=hljs-diff-line-added>        <span class=hljs-string>"required"</span>: <span class=hljs-literal>true</span>
</span><span id=code-req_affordance-40 class=hljs-diff-line-added>      }
</span><span id=code-req_affordance-41 class=hljs-diff-line-added>    }
</span><span id=code-req_affordance-42 class=hljs-diff-line-added>  }
</span><span id=code-req_affordance-43 class=hljs-diff-line-unchanged>}</span>
</code></pre><p>Let&#39;s see what happens when we submit the <code>update</code> form.</p><pre><code class="hljs sh"><span id=code-17-1>$ curl -X POST <span class=hljs-operator>-d</span> <span class=hljs-string>'{"name": "Carl"}'</span> -H <span class=hljs-string>'Content-type: application/hyper+json'</span> http://localhost:<span class=hljs-number>4000</span>/users/u1</span>
<span id=code-17-2><span class=hljs-literal>true</span></span>
</code></pre><h2>transition_to<a id=transition_to class=Header-anchor href=#transition_to aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>The response of <code>true</code> probably isn&#39;t the best when a request goes through. We want there to be a continuous flow for our clients since there are hypermedia driven. Imagine updating your user in the browser and getting the response <code>true</code>. You&#39;d have to hit the back button to get back to where you wanted to go. We can improve this experience by using the <code>transition_to</code> call.</p><pre><code class="hljs elixir[user_update_transition_to&lt;-user_update]"><span id=code-user_update_transition_to-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Update </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_transition_to-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-user_update_transition_to-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-user_update_transition_to-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-user_update_transition_to-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_transition_to-5 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_transition_to-6 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-user_update_transition_to-7 class=hljs-diff-line-unchanged>      <span class=hljs-constant>Users.</span>update(user, %{
</span><span id=code-user_update_transition_to-8 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; <span class=hljs-constant>Input.</span>get(<span class=hljs-string>"name"</span>)
</span><span id=code-user_update_transition_to-9 class=hljs-diff-line-unchanged>      })
</span><span id=code-user_update_transition_to-10 class=hljs-diff-line-removed>      <span class=hljs-keyword>true</span>
</span><span id=code-user_update_transition_to-11 class=hljs-diff-line-added>      transition_to(<span class=hljs-constant>MyAPI.Resource.Users.Read,</span> <span class=hljs-symbol>user:</span> user.id)
</span><span id=code-user_update_transition_to-12 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_transition_to-13 class=hljs-diff-line-unchanged>    affordance <span class=hljs-keyword>do</span>
</span><span id=code-user_update_transition_to-14 class=hljs-diff-line-unchanged>      %{
</span><span id=code-user_update_transition_to-15 class=hljs-diff-line-unchanged>        <span class=hljs-string>"input"</span> =&gt; %{
</span><span id=code-user_update_transition_to-16 class=hljs-diff-line-unchanged>          <span class=hljs-string>"name"</span> =&gt; %{
</span><span id=code-user_update_transition_to-17 class=hljs-diff-line-unchanged>            <span class=hljs-string>"type"</span> =&gt; <span class=hljs-string>"text"</span>,
</span><span id=code-user_update_transition_to-18 class=hljs-diff-line-unchanged>            <span class=hljs-string>"value"</span> =&gt; user.name,
</span><span id=code-user_update_transition_to-19 class=hljs-diff-line-unchanged>            <span class=hljs-string>"required"</span> =&gt; <span class=hljs-keyword>true</span>
</span><span id=code-user_update_transition_to-20 class=hljs-diff-line-unchanged>          }
</span><span id=code-user_update_transition_to-21 class=hljs-diff-line-unchanged>        }
</span><span id=code-user_update_transition_to-22 class=hljs-diff-line-unchanged>      }
</span><span id=code-user_update_transition_to-23 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span><span id=code-user_update_transition_to-24 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-user_update_transition_to-25 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><h2>condition<a id=condition class=Header-anchor href=#condition aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>The astute reader will notice that we&#39;ve now opened up changing a user&#39;s name to all clients. That&#39;s not good. Let&#39;s use the <code>condition</code> declaration to lock that down.</p><pre><code class="hljs elixir[user_update_cond&lt;-user_update_transition_to]"><span id=code-user_update_cond-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Update </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_cond-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-user_update_cond-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-user_update_cond-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-user_update_cond-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_cond-5 class=hljs-diff-line-added>  condition <span class=hljs-constant>Auth.</span>user_id == user.id
</span>
<span id=code-user_update_cond-6 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_cond-7 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-user_update_cond-8 class=hljs-diff-line-unchanged>      <span class=hljs-constant>Users.</span>update(user, %{
</span><span id=code-user_update_cond-9 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; <span class=hljs-constant>Input.</span>get(<span class=hljs-string>"name"</span>)
</span><span id=code-user_update_cond-10 class=hljs-diff-line-unchanged>      })
</span><span id=code-user_update_cond-11 class=hljs-diff-line-unchanged>      transition_to(<span class=hljs-constant>MyAPI.Resource.Users.Read,</span> <span class=hljs-symbol>user:</span> user.id)
</span><span id=code-user_update_cond-12 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_cond-13 class=hljs-diff-line-unchanged>    affordance <span class=hljs-keyword>do</span>
</span><span id=code-user_update_cond-14 class=hljs-diff-line-unchanged>      %{
</span><span id=code-user_update_cond-15 class=hljs-diff-line-unchanged>        <span class=hljs-string>"input"</span> =&gt; %{
</span><span id=code-user_update_cond-16 class=hljs-diff-line-unchanged>          <span class=hljs-string>"name"</span> =&gt; %{
</span><span id=code-user_update_cond-17 class=hljs-diff-line-unchanged>            <span class=hljs-string>"type"</span> =&gt; <span class=hljs-string>"text"</span>,
</span><span id=code-user_update_cond-18 class=hljs-diff-line-unchanged>            <span class=hljs-string>"value"</span> =&gt; user.name,
</span><span id=code-user_update_cond-19 class=hljs-diff-line-unchanged>            <span class=hljs-string>"required"</span> =&gt; <span class=hljs-keyword>true</span>
</span><span id=code-user_update_cond-20 class=hljs-diff-line-unchanged>          }
</span><span id=code-user_update_cond-21 class=hljs-diff-line-unchanged>        }
</span><span id=code-user_update_cond-22 class=hljs-diff-line-unchanged>      }
</span><span id=code-user_update_cond-23 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span><span id=code-user_update_cond-24 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-user_update_cond-25 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>Now let&#39;s see what happens when we request the user resource.</p><pre><code class="hljs sh[req_condition_user_id&lt;-req_affordance]"><span id=code-req_condition_user_id-0 class=hljs-diff-line-unchanged>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1
</span>
<span id=code-req_condition_user_id-1 class=hljs-diff-line-unchanged>{
</span><span id=code-req_condition_user_id-2 class=hljs-diff-line-unchanged>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_condition_user_id-3 class=hljs-diff-line-unchanged>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_condition_user_id-4 class=hljs-diff-line-unchanged>  <span class=hljs-string>"avatar"</span>: {
</span><span id=code-req_condition_user_id-5 class=hljs-diff-line-unchanged>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span>
</span><span id=code-req_condition_user_id-6 class=hljs-diff-line-unchanged>  },
</span><span id=code-req_condition_user_id-7 class=hljs-diff-line-unchanged>  <span class=hljs-string>"friends"</span>: [
</span><span id=code-req_condition_user_id-8 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id-9 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u2"</span>,
</span><span id=code-req_condition_user_id-10 class=hljs-diff-line-unchanged>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Robert"</span>
</span><span id=code-req_condition_user_id-11 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id-12 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id-13 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u3"</span>,
</span><span id=code-req_condition_user_id-14 class=hljs-diff-line-unchanged>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Mike"</span>
</span><span id=code-req_condition_user_id-15 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_condition_user_id-16 class=hljs-diff-line-unchanged>  ],
</span><span id=code-req_condition_user_id-17 class=hljs-diff-line-unchanged>  <span class=hljs-string>"interests"</span>: [
</span><span id=code-req_condition_user_id-18 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id-19 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m1"</span>
</span><span id=code-req_condition_user_id-20 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id-21 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id-22 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m2"</span>
</span><span id=code-req_condition_user_id-23 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id-24 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id-25 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b1"</span>
</span><span id=code-req_condition_user_id-26 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id-27 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id-28 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b2"</span>
</span><span id=code-req_condition_user_id-29 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_condition_user_id-30 class=hljs-diff-line-removed>  ],
</span><span id=code-req_condition_user_id-31 class=hljs-diff-line-removed>  <span class=hljs-string>"update"</span>: {
</span><span id=code-req_condition_user_id-32 class=hljs-diff-line-removed>    <span class=hljs-string>"method"</span>: <span class=hljs-string>"POST"</span>,
</span><span id=code-req_condition_user_id-33 class=hljs-diff-line-removed>    <span class=hljs-string>"action"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_condition_user_id-34 class=hljs-diff-line-removed>    <span class=hljs-string>"input"</span>: {
</span><span id=code-req_condition_user_id-35 class=hljs-diff-line-removed>      <span class=hljs-string>"name"</span>: {
</span><span id=code-req_condition_user_id-36 class=hljs-diff-line-removed>        <span class=hljs-string>"type"</span>: <span class=hljs-string>"text"</span>,
</span><span id=code-req_condition_user_id-37 class=hljs-diff-line-removed>        <span class=hljs-string>"value"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_condition_user_id-38 class=hljs-diff-line-removed>        <span class=hljs-string>"required"</span>: <span class=hljs-literal>true</span>
</span><span id=code-req_condition_user_id-39 class=hljs-diff-line-removed>      }
</span><span id=code-req_condition_user_id-40 class=hljs-diff-line-removed>    }
</span><span id=code-req_condition_user_id-41 class=hljs-diff-line-removed>  }
</span><span id=code-req_condition_user_id-42 class=hljs-diff-line-added>  ]
</span><span id=code-req_condition_user_id-43 class=hljs-diff-line-unchanged>}</span>
</code></pre><p>Nice! What happens if we make a request to the user update directly?</p><pre><code class="hljs sh"><span id=code-21-1>$ curl -X POST <span class=hljs-operator>-d</span> <span class=hljs-string>'{"name": "Carl"}'</span> -H <span class=hljs-string>'Content-type: application/hyper+json'</span> http://localhost:<span class=hljs-number>4000</span>/users/u1</span>
<span id=code-21-2></span>
<span id=code-21-3>{</span>
<span id=code-21-4>  <span class=hljs-string>"error"</span>: {</span>
<span id=code-21-5>    <span class=hljs-string>"code"</span>: <span class=hljs-number>401</span>,</span>
<span id=code-21-6>    <span class=hljs-string>"message"</span>: <span class=hljs-string>"You do not have access to this resource"</span></span>
<span id=code-21-7>  }</span>
<span id=code-21-8>}</span>
</code></pre><p>As you can see, a condition declaration will both prevent other resources linking to this resource and actions being executed. Notice how the resource in charge of processing the request is also in charge of determining if the affordance for the request should even be shown. This makes it very easy to secure any resource since all of the logic is in a single place. It also makes it very clear to clients what they can and can&#39;t do. If the <code>&quot;update&quot;</code> for is present in the resource then they can update; otherwise they shouldn&#39;t try because the request will fail.</p><p>Let&#39;s see what happens when we make a request with our API&#39;s token.</p><pre><code class="hljs sh[req_condition_user_id_success&lt;-req_condition_user_id]"><span id=code-req_condition_user_id_success-0 class=hljs-diff-line-removed>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1
</span><span id=code-req_condition_user_id_success-1 class=hljs-diff-line-added>$ curl http://localhost:<span class=hljs-number>4000</span>/users/u1 -H <span class=hljs-string>'Authorization: Bearer token_for_u1'</span>
</span>
<span id=code-req_condition_user_id_success-2 class=hljs-diff-line-unchanged>{
</span><span id=code-req_condition_user_id_success-3 class=hljs-diff-line-unchanged>  <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_condition_user_id_success-4 class=hljs-diff-line-unchanged>  <span class=hljs-string>"name"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_condition_user_id_success-5 class=hljs-diff-line-unchanged>  <span class=hljs-string>"avatar"</span>: {
</span><span id=code-req_condition_user_id_success-6 class=hljs-diff-line-unchanged>    <span class=hljs-string>"src"</span>: <span class=hljs-string>"https://avatars1.githubusercontent.com/u/99915?v=3&amp;s=460"</span>
</span><span id=code-req_condition_user_id_success-7 class=hljs-diff-line-unchanged>  },
</span><span id=code-req_condition_user_id_success-8 class=hljs-diff-line-unchanged>  <span class=hljs-string>"friends"</span>: [
</span><span id=code-req_condition_user_id_success-9 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id_success-10 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u2"</span>,
</span><span id=code-req_condition_user_id_success-11 class=hljs-diff-line-unchanged>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Robert"</span>
</span><span id=code-req_condition_user_id_success-12 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id_success-13 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id_success-14 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/users/u3"</span>,
</span><span id=code-req_condition_user_id_success-15 class=hljs-diff-line-unchanged>      <span class=hljs-string>"name"</span>: <span class=hljs-string>"Mike"</span>
</span><span id=code-req_condition_user_id_success-16 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_condition_user_id_success-17 class=hljs-diff-line-unchanged>  ],
</span><span id=code-req_condition_user_id_success-18 class=hljs-diff-line-unchanged>  <span class=hljs-string>"interests"</span>: [
</span><span id=code-req_condition_user_id_success-19 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id_success-20 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m1"</span>
</span><span id=code-req_condition_user_id_success-21 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id_success-22 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id_success-23 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/m2"</span>
</span><span id=code-req_condition_user_id_success-24 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id_success-25 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id_success-26 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b1"</span>
</span><span id=code-req_condition_user_id_success-27 class=hljs-diff-line-unchanged>    },
</span><span id=code-req_condition_user_id_success-28 class=hljs-diff-line-unchanged>    {
</span><span id=code-req_condition_user_id_success-29 class=hljs-diff-line-unchanged>      <span class=hljs-string>"href"</span>: <span class=hljs-string>"http://localhost:4000/interests/b2"</span>
</span><span id=code-req_condition_user_id_success-30 class=hljs-diff-line-unchanged>    }
</span><span id=code-req_condition_user_id_success-31 class=hljs-diff-line-removed>  ]
</span><span id=code-req_condition_user_id_success-32 class=hljs-diff-line-added>  ],
</span><span id=code-req_condition_user_id_success-33 class=hljs-diff-line-added>  <span class=hljs-string>"update"</span>: {
</span><span id=code-req_condition_user_id_success-34 class=hljs-diff-line-added>    <span class=hljs-string>"method"</span>: <span class=hljs-string>"POST"</span>,
</span><span id=code-req_condition_user_id_success-35 class=hljs-diff-line-added>    <span class=hljs-string>"action"</span>: <span class=hljs-string>"http://localhost:4000/users/u1"</span>,
</span><span id=code-req_condition_user_id_success-36 class=hljs-diff-line-added>    <span class=hljs-string>"input"</span>: {
</span><span id=code-req_condition_user_id_success-37 class=hljs-diff-line-added>      <span class=hljs-string>"name"</span>: {
</span><span id=code-req_condition_user_id_success-38 class=hljs-diff-line-added>        <span class=hljs-string>"type"</span>: <span class=hljs-string>"text"</span>,
</span><span id=code-req_condition_user_id_success-39 class=hljs-diff-line-added>        <span class=hljs-string>"value"</span>: <span class=hljs-string>"Joe"</span>,
</span><span id=code-req_condition_user_id_success-40 class=hljs-diff-line-added>        <span class=hljs-string>"required"</span>: <span class=hljs-literal>true</span>
</span><span id=code-req_condition_user_id_success-41 class=hljs-diff-line-added>      }
</span><span id=code-req_condition_user_id_success-42 class=hljs-diff-line-added>    }
</span><span id=code-req_condition_user_id_success-43 class=hljs-diff-line-added>  }
</span><span id=code-req_condition_user_id_success-44 class=hljs-diff-line-unchanged>}</span>
</code></pre><h2>error<a id=error class=Header-anchor href=#error aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>In the <a href=#condition>last section</a> we locked down user editing to only the resource owner. When we tried to make a request to the resource directly we got the default, generic error.</p><p>In this particular case, let&#39;s say we wanted to override this message. We can use the error declaration for this.</p><pre><code class="hljs elixir[user_update_error&lt;-user_update_cond]"><span id=code-user_update_error-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Update </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_error-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-user_update_error-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-user_update_error-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-user_update_error-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_error-5 class=hljs-diff-line-removed>  condition <span class=hljs-constant>Auth.</span>user_id == user.id
</span><span id=code-user_update_error-6 class=hljs-diff-line-added>  condition <span class=hljs-constant>Auth.</span>user_id == user.id, permission_error
</span>
<span id=code-user_update_error-7 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_error-8 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-user_update_error-9 class=hljs-diff-line-unchanged>      <span class=hljs-constant>Users.</span>update(user, %{
</span><span id=code-user_update_error-10 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; <span class=hljs-constant>Input.</span>get(<span class=hljs-string>"name"</span>)
</span><span id=code-user_update_error-11 class=hljs-diff-line-unchanged>      })
</span><span id=code-user_update_error-12 class=hljs-diff-line-unchanged>      transition_to(<span class=hljs-constant>MyAPI.Resource.Users.Read,</span> <span class=hljs-symbol>user:</span> user.id)
</span><span id=code-user_update_error-13 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_error-14 class=hljs-diff-line-unchanged>    affordance <span class=hljs-keyword>do</span>
</span><span id=code-user_update_error-15 class=hljs-diff-line-unchanged>      %{
</span><span id=code-user_update_error-16 class=hljs-diff-line-unchanged>        <span class=hljs-string>"input"</span> =&gt; %{
</span><span id=code-user_update_error-17 class=hljs-diff-line-unchanged>          <span class=hljs-string>"name"</span> =&gt; %{
</span><span id=code-user_update_error-18 class=hljs-diff-line-unchanged>            <span class=hljs-string>"type"</span> =&gt; <span class=hljs-string>"text"</span>,
</span><span id=code-user_update_error-19 class=hljs-diff-line-unchanged>            <span class=hljs-string>"value"</span> =&gt; user.name,
</span><span id=code-user_update_error-20 class=hljs-diff-line-unchanged>            <span class=hljs-string>"required"</span> =&gt; <span class=hljs-keyword>true</span>
</span><span id=code-user_update_error-21 class=hljs-diff-line-unchanged>          }
</span><span id=code-user_update_error-22 class=hljs-diff-line-unchanged>        }
</span><span id=code-user_update_error-23 class=hljs-diff-line-unchanged>      }
</span><span id=code-user_update_error-24 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_error-25 class=hljs-diff-line-added>    error permission_error(<span class=hljs-constant>_err)</span> <span class=hljs-keyword>do</span>
</span><span id=code-user_update_error-26 class=hljs-diff-line-added>      %{
</span><span id=code-user_update_error-27 class=hljs-diff-line-added>        <span class=hljs-string>"error"</span> =&gt; %{
</span><span id=code-user_update_error-28 class=hljs-diff-line-added>          <span class=hljs-string>"message"</span> =&gt; <span class=hljs-string>"Get lost!"</span>
</span><span id=code-user_update_error-29 class=hljs-diff-line-added>        }
</span><span id=code-user_update_error-30 class=hljs-diff-line-added>      }
</span><span id=code-user_update_error-31 class=hljs-diff-line-added>    <span class=hljs-keyword>end</span>
</span><span id=code-user_update_error-32 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span><span id=code-user_update_error-33 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre><p>As you might guess this is what we get back when requesting this resource without the correct permissions.</p><pre><code class="hljs sh"><span id=code-24-1>$ curl -X POST <span class=hljs-operator>-d</span> <span class=hljs-string>'{"name": "Carl"}'</span> -H <span class=hljs-string>'Content-type: application/hyper+json'</span> http://localhost:<span class=hljs-number>4000</span>/users/u1</span>
<span id=code-24-2></span>
<span id=code-24-3>{</span>
<span id=code-24-4>  <span class=hljs-string>"error"</span>: {</span>
<span id=code-24-5>    <span class=hljs-string>"message"</span>: <span class=hljs-string>"Get lost!"</span></span>
<span id=code-24-6>  }</span>
<span id=code-24-7>}</span>
</code></pre><h2>event<a id=event class=Header-anchor href=#event aria-hidden=true><span class=Header-anchor-icon></span></a></h2><p>A lot of times, we want to fire events when an action is performed. We can accomplish this by using the <code>event</code> declaration.</p><pre><code class="hljs elixir[user_update_event&lt;-user_update_error]"><span id=code-user_update_event-0 class=hljs-diff-line-unchanged><span class=hljs-class><span class=hljs-keyword>defmodule</span> <span class=hljs-title>MyAPI</span></span>.<span class=hljs-constant>Resource.Users.Update </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_event-1 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>use</span> <span class=hljs-constant>Mazurka.Resource</span>
</span>
<span id=code-user_update_event-2 class=hljs-diff-line-unchanged>  param user <span class=hljs-keyword>do</span>
</span><span id=code-user_update_event-3 class=hljs-diff-line-unchanged>    <span class=hljs-constant>Users.</span>read(value)
</span><span id=code-user_update_event-4 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_event-5 class=hljs-diff-line-unchanged>  condition <span class=hljs-constant>Auth.</span>user_id == user.id, permission_error
</span>
<span id=code-user_update_event-6 class=hljs-diff-line-unchanged>  mediatype <span class=hljs-constant>Mazurka.Mediatype.Hyperjson </span><span class=hljs-keyword>do</span>
</span><span id=code-user_update_event-7 class=hljs-diff-line-unchanged>    action <span class=hljs-keyword>do</span>
</span><span id=code-user_update_event-8 class=hljs-diff-line-unchanged>      <span class=hljs-constant>Users.</span>update(user, %{
</span><span id=code-user_update_event-9 class=hljs-diff-line-unchanged>        <span class=hljs-string>"name"</span> =&gt; <span class=hljs-constant>Input.</span>get(<span class=hljs-string>"name"</span>)
</span><span id=code-user_update_event-10 class=hljs-diff-line-unchanged>      })
</span><span id=code-user_update_event-11 class=hljs-diff-line-unchanged>      transition_to(<span class=hljs-constant>MyAPI.Resource.Users.Read,</span> <span class=hljs-symbol>user:</span> user.id)
</span><span id=code-user_update_event-12 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_event-13 class=hljs-diff-line-unchanged>    affordance <span class=hljs-keyword>do</span>
</span><span id=code-user_update_event-14 class=hljs-diff-line-unchanged>      %{
</span><span id=code-user_update_event-15 class=hljs-diff-line-unchanged>        <span class=hljs-string>"input"</span> =&gt; %{
</span><span id=code-user_update_event-16 class=hljs-diff-line-unchanged>          <span class=hljs-string>"name"</span> =&gt; %{
</span><span id=code-user_update_event-17 class=hljs-diff-line-unchanged>            <span class=hljs-string>"type"</span> =&gt; <span class=hljs-string>"text"</span>,
</span><span id=code-user_update_event-18 class=hljs-diff-line-unchanged>            <span class=hljs-string>"value"</span> =&gt; user.name,
</span><span id=code-user_update_event-19 class=hljs-diff-line-unchanged>            <span class=hljs-string>"required"</span> =&gt; <span class=hljs-keyword>true</span>
</span><span id=code-user_update_event-20 class=hljs-diff-line-unchanged>          }
</span><span id=code-user_update_event-21 class=hljs-diff-line-unchanged>        }
</span><span id=code-user_update_event-22 class=hljs-diff-line-unchanged>      }
</span><span id=code-user_update_event-23 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_event-24 class=hljs-diff-line-unchanged>    error permission_error(<span class=hljs-constant>_err)</span> <span class=hljs-keyword>do</span>
</span><span id=code-user_update_event-25 class=hljs-diff-line-unchanged>      %{
</span><span id=code-user_update_event-26 class=hljs-diff-line-unchanged>        <span class=hljs-string>"error"</span> =&gt; %{
</span><span id=code-user_update_event-27 class=hljs-diff-line-unchanged>          <span class=hljs-string>"message"</span> =&gt; <span class=hljs-string>"Get lost!"</span>
</span><span id=code-user_update_event-28 class=hljs-diff-line-unchanged>        }
</span><span id=code-user_update_event-29 class=hljs-diff-line-unchanged>      }
</span><span id=code-user_update_event-30 class=hljs-diff-line-unchanged>    <span class=hljs-keyword>end</span>
</span><span id=code-user_update_event-31 class=hljs-diff-line-unchanged>  <span class=hljs-keyword>end</span>
</span>
<span id=code-user_update_event-32 class=hljs-diff-line-added>  event <span class=hljs-keyword>do</span>
</span><span id=code-user_update_event-33 class=hljs-diff-line-added>    <span class=hljs-constant>Analytics.</span>record(<span class=hljs-symbol>:user_update</span>, %{
</span><span id=code-user_update_event-34 class=hljs-diff-line-added>      <span class=hljs-string>"id"</span> =&gt; user.id,
</span><span id=code-user_update_event-35 class=hljs-diff-line-added>      <span class=hljs-string>"before"</span> =&gt; user.name,
</span><span id=code-user_update_event-36 class=hljs-diff-line-added>      <span class=hljs-string>"after"</span> =&gt; <span class=hljs-constant>Input.</span>get(<span class=hljs-string>"name"</span>)
</span><span id=code-user_update_event-37 class=hljs-diff-line-added>    })
</span><span id=code-user_update_event-38 class=hljs-diff-line-added>  <span class=hljs-keyword>end</span>
</span><span id=code-user_update_event-39 class=hljs-diff-line-unchanged><span class=hljs-keyword>end</span></span>
</code></pre></div></div><footer></footer><script src=/main.min.js></script>